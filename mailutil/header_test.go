package mailutil

import (
	"strings"
	"testing"
)

// https://tools.ietf.org/html/rfc5322#section-2.2.3 "the field body portion of a header field can be split into a multiple-line representation" (field body only!)

func TestFold(t *testing.T) {

	tests := []struct {
		name     string
		body     string
		expected string
	}{
		// real-world example
		{"List-Id", `"test" <test@example.com>`, `List-Id: "test" <test@example.com>` + "\r\n"},
		// many spaces
		{"Some-Header", "Foo bar baz", "Some-Header: Foo bar baz\r\n"},
		// collapse spaces, no empty lines in output
		{"Some-Header", "012345678901234567890123456789                    01234567890123456789012345678901234", "Some-Header: 012345678901234567890123456789\r\n 01234567890123456789012345678901234\r\n"},
		{"Some-Header", "012345678901234567890123456789                                                                                                    01234567890123456789012345678901234", "Some-Header: 012345678901234567890123456789\r\n 01234567890123456789012345678901234\r\n"},
		// don't fold directly after header name, even if it's longer than 80 chars
		{"Some-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Long-Header", "0", "Some-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Long-Header: 0\r\n"},
		{"Some-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Long-Header", "  0", "Some-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Long-Header: 0\r\n"},
		{"Some-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Long-Header", "  01234567890123456789012345678901234567890123456789012345678901234 5678", "Some-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Very-Long-Header: 01234567890123456789012345678901234567890123456789012345678901234\r\n 5678\r\n"},
		// no folding
		{"Some-Header", "01234567890123456789012345678901234567890123456789012345678901234", "Some-Header: 01234567890123456789012345678901234567890123456789012345678901234\r\n"},
		// folding at whitespace
		{"Some-Header", "01234567890123456789012345678901234567890123456789012345678901234 5", "Some-Header: 01234567890123456789012345678901234567890123456789012345678901234\r\n 5\r\n"},
		{"Some-Header", "0123456789012345678901234567890123456789012345678901234567890123 45", "Some-Header: 0123456789012345678901234567890123456789012345678901234567890123\r\n 45\r\n"},
		{"Some-Header", "012345678901234567890123456789012345678901234567890123456789012 345", "Some-Header: 012345678901234567890123456789012345678901234567890123456789012\r\n 345\r\n"},
		{"Some-Header", "012 345678901234567890123456789012345678901234567890123456789012345", "Some-Header: 012\r\n 345678901234567890123456789012345678901234567890123456789012345\r\n"},
		{"Some-Header", "01 2345678901234567890123456789012345678901234567890123456789012345", "Some-Header: 01\r\n 2345678901234567890123456789012345678901234567890123456789012345\r\n"},
		{"Some-Header", "0 12345678901234567890123456789012345678901234567890123456789012345", "Some-Header: 0\r\n 12345678901234567890123456789012345678901234567890123456789012345\r\n"},
		// folding at whitespace > 78
		{"Some-Header", "01234567890123456789012345678901234567890123456789012345678901234567\t8", "Some-Header: 01234567890123456789012345678901234567890123456789012345678901234567\r\n 8\r\n"},
		{"Some-Header", "0123456789012345678901234567890123456789012345678901234567890123456\t78", "Some-Header: 0123456789012345678901234567890123456789012345678901234567890123456\r\n 78\r\n"},
		{"Some-Header", "012345678901234567890123456789012345678901234567890123456789012345\t678", "Some-Header: 012345678901234567890123456789012345678901234567890123456789012345\r\n 678\r\n"},
		{"Some-Header", "01234567890123456789012345678901234567890123456789012345678901234\t5678", "Some-Header: 01234567890123456789012345678901234567890123456789012345678901234\r\n 5678\r\n"},
		// folding at multiple whitespaces, and not directly after the header field name
		{"Some-Header", "0123456789012345678901234567890123456789012345678901234567890123456789 0123456789 0123456789012345678901234567890123456789012345678901234567890123456789", "Some-Header: 0123456789012345678901234567890123456789012345678901234567890123456789\r\n 0123456789\r\n 0123456789012345678901234567890123456789012345678901234567890123456789\r\n"},
		// ...even when there are spaces around the input
		{"Some-Header", "   0123456789012345678901234567890123456789012345678901234567890123456789 0123456789 0123456789012345678901234567890123456789012345678901234567890123456789   ", "Some-Header: 0123456789012345678901234567890123456789012345678901234567890123456789\r\n 0123456789\r\n 0123456789012345678901234567890123456789012345678901234567890123456789\r\n"},
		// hard crops
		{"Some-Header", "01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345", "Some-Header: 0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234\r\n 5\r\n"},
		{"Some-Header", "01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789", "Some-Header: 0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234\r\n 5678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789\r\n"},
		{"Some-Header", "0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789", "Some-Header: 0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234\r\n 5678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901\r\n 23456789\r\n"},
	}

	for _, test := range tests {

		writer := &strings.Builder{}
		err := headerWritelnFold(writer, test.name, test.body)
		got := writer.String()

		if got != test.expected || err != nil {
			t.Errorf("got %s %v, want %s", got, err, test.expected)
		}

		for _, line := range strings.Split(got, "\r\n") {
			if len(line) > 998 {
				t.Errorf("got line with length %d", len(line))
			}
		}
	}
}
